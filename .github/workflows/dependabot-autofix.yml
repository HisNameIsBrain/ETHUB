name: dependabot-autofix

on:
  pull_request_target:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  autofix:
    # Only act on Dependabot PRs
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          fetch-depth: 0  # required so git-auto-commit can push

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # Auto-fix what can be auto-fixed
      - name: Run format & lint autofix
        run: |
          npx prettier --write . || true
          npx eslint . --ext .ts,.tsx --fix || true

      # Optional: keep as "soft" checks so they don't block autofixes
      - name: Typecheck (soft)
        run: npm run typecheck || npx tsc --noEmit
        continue-on-error: true

      - name: Tests (soft)
        run: npm test
        continue-on-error: true

      # Hard gate: build must pass or the job fails
      - name: Build (required)
        run: npm run build

      - name: Commit changes (if any)
        if: success()  # only commit if build (and earlier hard steps) succeeded
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: autofix (prettier/eslint) on dependabot PR"
          branch: ${{ github.event.pull_request.head.ref }}
