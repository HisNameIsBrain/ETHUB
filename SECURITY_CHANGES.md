# Security Changes and Risk Notes

## Current changes (paths, lines, severity)
- Local-only voice service guard (`lib/voice/config.ts` lines 15-22): blocks any non-localhost VOICE_SERVICE_URL usage. **Severity mitigated:** High (prevents remote voice endpoint exposure). Enforced by callers in `/app/api/voice/train/route.ts` and `/app/api/voice/speak/route.ts`.
- IP allowlist enforcement (`lib/voice/config.ts` lines 14-47): rejects voice API requests unless the client IP matches the allowlist (defaults to loopback only or `VOICE_ALLOWED_IPS`). **Severity mitigated:** High (ensures voice endpoints are reachable only from explicitly permitted addresses). Applied across all voice API routes.
- Encrypted-at-rest voice storage (`lib/voice/crypto.ts` and `lib/voice/storage.ts`): per-user HKDF AES-256-GCM for recordings and metadata outside `public/`. **Severity mitigated:** High (protects recorded audio if filesystem is accessed).
- Dependency patches (`package.json`): `jsonwebtoken@9.0.3`, `autoprefixer@10.4.23`, `tailwindcss@3.4.19`. **Severity mitigated:** Medium (applies upstream security/maintenance fixes).

## Residual audit findings
- `cookie <0.7.0` (transitive via `@edgestore/react` and `@edgestore/server`): **Low** severity advisory GHSA-pxg6-pf52-xh8x. No vendor fix available; monitor upstream or replace dependency when possible. (npm audit)

## Network and API exposure
- Voice APIs remain Clerk-authenticated with per-user isolation, and training/speak endpoints enforce the localhost-only guard to avoid any remote voice service calls.

## Encryption and storage handling
- Voice recordings continue to use per-user HKDF-derived AES-256-GCM encryption with metadata stored under `.private/voice`, which is not publicly served.

## Blockchain/crypto key tracking
- No blockchain or cryptocurrency keys are stored, tracked, or generated by this codebase. There is no on-chain registry of audio assets, so no recovery or ownership handoff is applicable or needed for digital files here.

## General reasoning
- Changes are limited to security hardening and documentation that reduce remote exposure and clarify encryption posture without introducing new external dependencies.
