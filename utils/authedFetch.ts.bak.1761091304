export function makeAuthedFetch(tokenSupplier: () => Promise<string | null>) {
  return async function authedFetch(
    url: string,
    init: RequestInit = {},
    options: { retryOnce?: boolean; parseJson?: boolean } = {}
  ) {
    const { retryOnce = true, parseJson = false } = options;

    const doFetch = async (t: string) =>
      fetch(url, {
        ...init,
        headers: {
          "Content-Type": "application/json",
          ...(init.headers || {}),
          Authorization: `Bearer ${t}`,
        },
        credentials: "include",
        cache: "no-store",
      });

    let token = await tokenSupplier();
    if (!token) throw new Error("[authedFetch] Missing JWT token");

    let res = await doFetch(token);

    if (retryOnce && res.status === 401) {
      const fresh = await tokenSupplier().catch(() => null);
      if (fresh) res = await doFetch(fresh);
    }

    if (parseJson) {
      try {
        const data = await res.json();
        return { ok: res.ok, status: res.status, data };
      } catch {
        return { ok: res.ok, status: res.status, data: null };
      }
    }

    return res;
  };
}
